# ============================================================================
# GAMELAN GLiNER2 EXECUTOR CONFIGURATION
# ============================================================================

# Application Configuration (application.yml)
quarkus:
  application:
    name: gamelan-gliner-executors
  
  # HTTP Configuration
  http:
    port: 8081
    
  # Logging
  log:
    level: INFO
    category:
      "tech.kayys.gamelan.executor.nlp.gliner":
        level: DEBUG

# GLiNER Service Configuration
gamelan:
  gliner:
    # Python bridge endpoint
    endpoint: http://localhost:8000
    
    # Request timeout
    timeout-seconds: 30
    
    # Retry configuration
    max-retries: 3
    retry-backoff-ms: 100
    
    # Circuit breaker
    circuit-breaker-threshold: 5
    circuit-breaker-reset-timeout-seconds: 60
    
    # Model configuration
    models:
      default:
        model-id: "urchade/gliner_multi_pii-v1"
        device: "cuda"  # or "cpu"
        fp16: true
        batch-size: 32
        max-length: 512
      
      # Additional models
      finance:
        model-id: "urchade/gliner_multi-v2.1"
        device: "cuda"
        fp16: true
      
      medical:
        model-id: "urchade/gliner_multi_pii-v1"
        device: "cuda"
        fp16: true
    
    # Executor configuration
    executors:
      ner:
        max-concurrent-tasks: 50
        enable-caching: true
        cache-size: 1000
      
      classification:
        max-concurrent-tasks: 100
        enable-caching: true
      
      extraction:
        max-concurrent-tasks: 50
        strict-mode-default: true
      
      relation:
        max-concurrent-tasks: 30
        max-distance-default: 50

  # Executor Runtime Configuration
  executor:
    # Transport type: GRPC, KAFKA, or REST
    transport: GRPC
    
    # Engine endpoints
    engine:
      grpc-endpoint: localhost:9090
      rest-endpoint: http://localhost:8080
    
    # Registration
    auto-register: true
    executor-id: gliner-executor-instance-1
    heartbeat-interval-seconds: 10
    
  # Multi-tenancy
  tenant:
    isolation-mode: STRICT
    default-tenant-id: default

# Schema Registry Configuration
schema:
  registry:
    # Database configuration for schema storage
    datasource:
      db-kind: postgresql
      username: gamelan
      password: gamelan_password
      jdbc:
        url: jdbc:postgresql://localhost:5432/gamelan_schemas
    
    # Cache configuration
    cache:
      enabled: true
      ttl-minutes: 60
      max-size: 500

# Metrics and Monitoring
management:
  endpoints:
    web:
      exposure:
        include: health,metrics,info
  
  metrics:
    export:
      prometheus:
        enabled: true

---
# ============================================================================
# EXAMPLE: WORKFLOW DEFINITION USING GLiNER EXECUTORS
# ============================================================================
# File: examples/contract-analysis-workflow.yaml

workflowDefinition:
  name: "contract-analysis-pipeline"
  version: "1.0.0"
  description: "Analyze legal contracts using GLiNER2 NLP"
  
  inputs:
    contractText:
      type: string
      required: true
      description: "Full contract text"
    
    analysisType:
      type: string
      required: false
      default: "full"
      description: "Type of analysis: full, entities, relations"
  
  nodes:
    # Step 1: Extract Named Entities
    - id: "extract-entities"
      name: "Extract Legal Entities"
      type: TASK
      executorType: "gliner-ner-executor"
      config:
        entityTypes:
          - "PERSON"
          - "ORGANIZATION"
          - "DATE"
          - "MONEY"
          - "LOCATION"
          - "CONTRACT_CLAUSE"
          - "OBLIGATION"
          - "TERMINATION_CONDITION"
        confidenceThreshold: 0.6
        extractionMode: "NESTED"
        enableNestedEntities: true
        modelId: "urchade/gliner_multi-v2.1"
      dependsOn: []
      transitions:
        - targetNode: "classify-contract-type"
          condition: "SUCCESS"
    
    # Step 2: Classify Contract Type
    - id: "classify-contract-type"
      name: "Classify Contract Type"
      type: TASK
      executorType: "gliner-classification-executor"
      config:
        labels:
          - "Employment Agreement"
          - "Service Agreement"
          - "Non-Disclosure Agreement"
          - "Partnership Agreement"
          - "License Agreement"
          - "Sales Agreement"
        mode: "SINGLE_LABEL"
        topK: 3
        confidenceThreshold: 0.4
      dependsOn: ["extract-entities"]
      transitions:
        - targetNode: "extract-structured-data"
          condition: "SUCCESS"
    
    # Step 3: Extract Structured Data
    - id: "extract-structured-data"
      name: "Extract Contract Terms"
      type: TASK
      executorType: "gliner-extraction-executor"
      config:
        schema:
          schemaName: "contract-terms"
          version: "1.0.0"
          fields:
            - fieldName: "effectiveDate"
              fieldType: "DATE"
              required: true
              description: "Contract effective date"
            
            - fieldName: "expirationDate"
              fieldType: "DATE"
              required: false
              description: "Contract expiration date"
            
            - fieldName: "parties"
              fieldType: "ENTITY"
              required: true
              multiple: true
              description: "Contract parties"
            
            - fieldName: "totalValue"
              fieldType: "NUMBER"
              required: false
              description: "Total contract value"
            
            - fieldName: "paymentTerms"
              fieldType: "STRING"
              required: false
              description: "Payment terms and conditions"
            
            - fieldName: "terminationClauses"
              fieldType: "STRING"
              required: false
              multiple: true
              description: "Termination conditions"
        
        strictMode: false
        threshold: 0.5
      dependsOn: ["classify-contract-type"]
      transitions:
        - targetNode: "extract-relationships"
          condition: "SUCCESS"
    
    # Step 4: Extract Entity Relationships
    - id: "extract-relationships"
      name: "Extract Entity Relationships"
      type: TASK
      executorType: "gliner-relation-executor"
      config:
        entityTypes:
          - "PERSON"
          - "ORGANIZATION"
          - "OBLIGATION"
          - "PAYMENT"
        
        relationTypes:
          - relationName: "PARTY_TO"
            sourceEntityType: "PERSON"
            targetEntityType: "ORGANIZATION"
            bidirectional: false
            triggers: ["employee of", "contractor for", "represents"]
          
          - relationName: "OBLIGATED_TO"
            sourceEntityType: "PERSON"
            targetEntityType: "OBLIGATION"
            bidirectional: false
            triggers: ["shall", "must", "required to", "agrees to"]
          
          - relationName: "PAYMENT_FROM"
            sourceEntityType: "ORGANIZATION"
            targetEntityType: "PERSON"
            bidirectional: false
            triggers: ["pays", "compensates", "remuneration"]
        
        maxDistance: 100
        threshold: 0.5
      dependsOn: ["extract-structured-data"]
      transitions:
        - targetNode: "generate-analysis-report"
          condition: "SUCCESS"
    
    # Step 5: Generate Analysis Report
    - id: "generate-analysis-report"
      name: "Generate Contract Analysis Report"
      type: TASK
      executorType: "report-generator"
      config:
        templateId: "contract-analysis-template"
        format: "PDF"
        includeVisualizations: true
      dependsOn: ["extract-relationships"]
  
  outputs:
    entities:
      type: object
      description: "Extracted entities"
    
    contractType:
      type: string
      description: "Classified contract type"
    
    structuredData:
      type: object
      description: "Extracted structured contract terms"
    
    relationships:
      type: array
      description: "Extracted entity relationships"
    
    analysisReport:
      type: string
      description: "URL to generated analysis report"

---
# ============================================================================
# EXAMPLE: JAVA USAGE
# ============================================================================

# File: examples/ContractAnalysisExample.java
/*
package tech.kayys.gamelan.examples;

import tech.kayys.gamelan.client.GamelanClient;
import tech.kayys.gamelan.api.dto.RunResponse;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.Map;

public class ContractAnalysisExample {
    
    public static void main(String[] args) throws Exception {
        // Create Gamelan client
        GamelanClient client = GamelanClient.builder()
            .restEndpoint("http://localhost:8080")
            .tenantId("acme-corp")
            .apiKey("your-api-key")
            .build();
        
        // Read contract text
        String contractText = Files.readString(
            Paths.get("contracts/service-agreement-001.txt")
        );
        
        // Execute contract analysis workflow
        RunResponse run = client.runs()
            .create("contract-analysis-pipeline")
            .input("contractText", contractText)
            .input("analysisType", "full")
            .label("department", "legal")
            .label("priority", "high")
            .executeAndStart()
            .await().indefinitely();
        
        System.out.println("Contract analysis started: " + run.runId());
        
        // Wait for completion
        boolean completed = false;
        while (!completed) {
            Thread.sleep(2000);
            
            RunResponse status = client.runs()
                .get(run.runId())
                .await().indefinitely();
            
            System.out.println("Status: " + status.status());
            
            if (status.status().equals("COMPLETED")) {
                completed = true;
                
                // Extract results
                Map<String, Object> variables = status.variables();
                
                System.out.println("\n=== Analysis Results ===");
                System.out.println("Contract Type: " + 
                    variables.get("contractType"));
                System.out.println("Entities Found: " + 
                    ((Map<?, ?>) variables.get("entities")).size());
                System.out.println("Relationships: " + 
                    ((java.util.List<?>) variables.get("relationships")).size());
                System.out.println("Report: " + 
                    variables.get("analysisReport"));
                
            } else if (status.status().equals("FAILED")) {
                completed = true;
                System.err.println("Workflow failed!");
            }
        }
        
        client.close();
    }
}
*/

---
# ============================================================================
# EXAMPLE: SCHEMA DEFINITIONS
# ============================================================================

# File: schemas/medical-record-ner-schema.yaml
schemaId: "medical-record-ner-v1"
schemaName: "Medical Record NER"
version: "1.0.0"
taskType: NER
tenantId: "healthcare-tenant"
description: "Extract medical entities from clinical notes"

entityTypes:
  - entityType: "SYMPTOM"
    displayName: "Symptom"
    description: "Patient symptoms and complaints"
    examples:
      - "fever"
      - "headache"
      - "chest pain"
    category: CUSTOM
    minConfidence: 0.6
  
  - entityType: "DIAGNOSIS"
    displayName: "Diagnosis"
    description: "Medical diagnosis"
    examples:
      - "hypertension"
      - "diabetes mellitus"
      - "pneumonia"
    category: CUSTOM
    minConfidence: 0.7
  
  - entityType: "MEDICATION"
    displayName: "Medication"
    description: "Prescribed medications"
    examples:
      - "metformin"
      - "lisinopril"
      - "aspirin"
    category: CUSTOM
    minConfidence: 0.7
  
  - entityType: "DOSAGE"
    displayName: "Dosage"
    description: "Medication dosage"
    examples:
      - "500mg"
      - "twice daily"
      - "10ml"
    category: NUMERIC
    minConfidence: 0.8
  
  - entityType: "PROCEDURE"
    displayName: "Medical Procedure"
    description: "Medical procedures and tests"
    examples:
      - "blood test"
      - "CT scan"
      - "surgery"
    category: EVENT
    minConfidence: 0.6

modelConfig:
  modelId: "urchade/gliner_multi_pii-v1"
  modelVersion: "latest"
  modelSource: HUGGINGFACE
  deviceConfig:
    deviceType: CUDA
    deviceId: 0
    fp16Enabled: true

---
# File: schemas/financial-extraction-schema.yaml
schemaId: "invoice-extraction-v1"
schemaName: "Invoice Data Extraction"
version: "1.0.0"
taskType: EXTRACTION
tenantId: "finance-tenant"
description: "Extract structured data from invoices"

schema:
  schemaName: "invoice-data"
  version: "1.0.0"
  fields:
    - fieldName: "invoiceNumber"
      fieldType: STRING
      required: true
      description: "Unique invoice number"
      validationPatterns:
        - "^INV-\\d{6}$"
    
    - fieldName: "invoiceDate"
      fieldType: DATE
      required: true
      description: "Invoice date"
      expectedFormats:
        - "YYYY-MM-DD"
        - "DD/MM/YYYY"
    
    - fieldName: "vendorName"
      fieldType: STRING
      required: true
      description: "Vendor/supplier name"
    
    - fieldName: "totalAmount"
      fieldType: NUMBER
      required: true
      description: "Total invoice amount"
    
    - fieldName: "lineItems"
      fieldType: ARRAY
      required: false
      multiple: true
      description: "Individual line items"
    
    - fieldName: "taxAmount"
      fieldType: NUMBER
      required: false
      description: "Total tax amount"
    
    - fieldName: "dueDate"
      fieldType: DATE
      required: false
      description: "Payment due date"

---
# ============================================================================
# DOCKER COMPOSE FOR LOCAL DEVELOPMENT
# ============================================================================

# File: docker-compose.yml
version: '3.8'

services:
  # GLiNER Python Bridge
  gliner-service:
    build:
      context: ./gliner-bridge
      dockerfile: Dockerfile
    image: gamelan/gliner-bridge:latest
    ports:
      - "8000:8000"
      - "50051:50051"
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - MODEL_CACHE_DIR=/models
      - LOG_LEVEL=INFO
    volumes:
      - ./models:/models
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
  
  # Gamelan Workflow Engine
  gamelan-engine:
    image: gamelan/engine:latest
    ports:
      - "8080:8080"
      - "9090:9090"
    environment:
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://postgres:5432/gamelan
      - QUARKUS_DATASOURCE_USERNAME=gamelan
      - QUARKUS_DATASOURCE_PASSWORD=gamelan_password
    depends_on:
      - postgres
      - kafka
  
  # GLiNER Executors
  gliner-executors:
    build:
      context: .
      dockerfile: Dockerfile.executors
    image: gamelan/gliner-executors:latest
    ports:
      - "8081:8081"
    environment:
      - GAMELAN_GLINER_ENDPOINT=http://gliner-service:8000
      - GAMELAN_EXECUTOR_ENGINE_GRPC_ENDPOINT=gamelan-engine:9090
    depends_on:
      - gliner-service
      - gamelan-engine
  
  # PostgreSQL
  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=gamelan
      - POSTGRES_USER=gamelan
      - POSTGRES_PASSWORD=gamelan_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
  
  # Kafka
  kafka:
    image: confluentinc/cp-kafka:latest
    ports:
      - "9092:9092"
    environment:
      - KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092

  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    ports:
      - "2181:2181"
    environment:
      - ZOOKEEPER_CLIENT_PORT=2181

volumes:
  postgres_data:
  models:

  