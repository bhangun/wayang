---
# modules/services/plugin-registry-service/src/main/resources/application.yml

quarkus:
  application:
    name: plugin-registry-service
    version: 1.0.0

  # HTTP Configuration
  http:
    port: 8080
    host: 0.0.0.0
    cors: true
    
  # Database Configuration
  datasource:
    db-kind: postgresql
    username: ${DB_USERNAME:wayang}
    password: ${DB_PASSWORD:wayang}
    jdbc:
      url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:plugin_registry}
      max-size: 20
      min-size: 5
  
  hibernate-orm:
    database:
      generation: none
    log:
      sql: ${LOG_SQL:false}
  
  # Flyway Migration
  flyway:
    migrate-at-start: true
    baseline-on-migrate: true
    locations: classpath:db/migration

  # Reactive Messaging - Kafka
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
    
  smallrye-messaging:
    outgoing:
      plugin-events:
        connector: smallrye-kafka
        topic: plugin-events
        key.serializer: org.apache.kafka.common.serialization.StringSerializer
        value.serializer: io.quarkus.kafka.client.serialization.JsonbSerializer

  # OpenAPI
  smallrye-openapi:
    path: /openapi
    info-title: Plugin Registry API
    info-version: 1.0.0
    info-description: API for plugin registration and discovery

  # Security
  security:
    jwt:
      enabled: true
      public-key: ${JWT_PUBLIC_KEY}
    
  oidc:
    enabled: ${OIDC_ENABLED:false}
    auth-server-url: ${OIDC_SERVER_URL}
    client-id: ${OIDC_CLIENT_ID}

  # Observability
  log:
    level: INFO
    category:
      "io.wayang": DEBUG
    console:
      format: "%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%c{3.}] (%t) %s%e%n"
      json: ${LOG_JSON:true}

  # Micrometer Metrics
  micrometer:
    enabled: true
    export:
      prometheus:
        enabled: true
        path: /metrics

  # OpenTelemetry Tracing
  opentelemetry:
    enabled: true
    tracer:
      exporter:
        otlp:
          endpoint: ${OTEL_EXPORTER_OTLP_ENDPOINT:http://localhost:4317}

# Custom Configuration
plugin:
  registry:
    auto-approve-trusted: false
    require-signature: true
    max-version-history: 10
  
  cache:
    enabled: true
    ttl: 3600 # seconds
  
  security:
    allowed-repositories:
      - https://repo1.maven.org/maven2
      - https://internal-nexus.company.com/repository
