{
    "$id": "https://kayys.tech/schema/v1/rules.schema.json",
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Rule Schema",
    "type": "object",
    "properties": {
        "allowedConnections": {
            "type": "array",
            "description": "Whitelist of allowed node-type or port-type connections",
            "items": {
                "type": "object",
                "required": [
                    "from",
                    "to"
                ],
                "properties": {
                    "from": {
                        "type": "object",
                        "properties": {
                            "nodeType": {
                                "type": "string"
                            },
                            "portName": {
                                "type": "string"
                            },
                            "portType": {
                                "type": "string"
                            }
                        }
                    },
                    "to": {
                        "type": "object",
                        "properties": {
                            "nodeType": {
                                "type": "string"
                            },
                            "portName": {
                                "type": "string"
                            },
                            "portType": {
                                "type": "string"
                            }
                        }
                    },
                    "maxConnections": {
                        "type": "integer",
                        "minimum": 1,
                        "description": "Optional. Maximum number of edges allowed from 'from' â†’ 'to'"
                    },
                    "direction": {
                        "type": "string",
                        "enum": [
                            "forward",
                            "reverse",
                            "bidirectional"
                        ],
                        "default": "forward"
                    }
                }
            }
        },
        "disallowedConnections": {
            "type": "array",
            "description": "Blacklist of forbidden node-type or port-type connections",
            "items": {
                "type": "object",
                "properties": {
                    "from": {
                        "type": "object",
                        "properties": {
                            "nodeType": {
                                "type": "string"
                            },
                            "portType": {
                                "type": "string"
                            },
                            "portName": {
                                "type": "string"
                            }
                        }
                    },
                    "to": {
                        "type": "object",
                        "properties": {
                            "nodeType": {
                                "type": "string"
                            },
                            "portType": {
                                "type": "string"
                            },
                            "portName": {
                                "type": "string"
                            }
                        }
                    },
                    "reason": {
                        "type": "string"
                    }
                }
            }
        },
        "topologyRules": {
            "type": "object",
            "properties": {
                "allowCycles": {
                    "type": "boolean",
                    "default": false
                },
                "maxDepth": {
                    "type": "integer",
                    "minimum": 1
                },
                "maxFanIn": {
                    "type": "integer",
                    "minimum": 1
                },
                "maxFanOut": {
                    "type": "integer",
                    "minimum": 1
                },
                "entryNodeTypes": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "exitNodeTypes": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                }
            }
        },
        "customRules": {
            "type": "array",
            "description": "CEL expressions evaluated on each attempted connection",
            "items": {
                "type": "object",
                "required": [
                    "expression",
                    "errorMessage"
                ],
                "properties": {
                    "expression": {
                        "type": "string",
                        "description": "CEL expression with context: fromNode, toNode, fromPort, toPort, workflow"
                    },
                    "severity": {
                        "type": "string",
                        "enum": [
                            "error",
                            "warning"
                        ],
                        "default": "error"
                    },
                    "errorMessage": {
                        "type": "string"
                    }
                }
            }
        }
    }
}